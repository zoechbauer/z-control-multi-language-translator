# Fixing "invalid source release: 21" Error in Capacitor Android Projects

## Error Description

When building a Capacitor-based Android project (e.g., with `ionic cap run android --external`), you may encounter the following error:

```
Execution failed for task ':capacitor-android:compileDebugJavaWithJavac'.
> error: invalid source release: 21
```

This error occurs because the generated Gradle configuration sets the Java source/target compatibility to Java 21 (`JavaVersion.VERSION_21`), but your system is using Java 17. The build fails since Java 21 features are not available in Java 17.

## Solution

To resolve this, you need to force all subprojects (including those generated by Capacitor) to use Java 17 for compilation.

### Steps

1. **Open** `android/build.gradle` (the top-level Gradle file in your Android project).
2. **Add** the following block at the end of the file:

    ```gradle
    // Force Java 17 for all subprojects (including generated ones)
    subprojects {
        afterEvaluate { project ->
            if (project.hasProperty("android")) {
                project.android.compileOptions.sourceCompatibility = JavaVersion.VERSION_17
                project.android.compileOptions.targetCompatibility = JavaVersion.VERSION_17
            }
        }
    }
    ```

3. **Sync and rebuild** your project:
    - Run `npx cap sync android`
    - Run `ionic cap run android --external`
    - You can also build/install via Android Studio

### Why This Works

Capacitor auto-generates some Gradle files and may set the Java version to 21. By adding the above block to the root `build.gradle`, you override the Java version for all modules, ensuring compatibility with Java 17.

## References

- [Capacitor Android Build Issues](https://capacitorjs.com/docs/v4/updating/4-0#android)
- [Gradle compileOptions Documentation](https://developer.android.com/studio/build/gradle-plugin-3-0-0-migration#java8)

---

**Summary:**  
If you see `invalid source release: 21` and are using Java 17, add the subprojects block above to your root `android/build.gradle` to force Java 17 for all modules.